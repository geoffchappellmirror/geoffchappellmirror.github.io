<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>KSE_HOOK_COLLECTION</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../_styles/master.css">
<link rel="stylesheet" type="text/css" href="../../../../../../../_styles/document.css">
<link rel="stylesheet" type="text/css" href="../../../../_styles/km.css">
<script type="text/javascript" src="../../../../../../../_scripts/master.js"></script>
<script type="text/javascript" src="../../../../../../../_scripts/document.js"></script>
<script type="text/javascript" src="../../../../_scripts/km.js"></script>
</head>

<body>

<!--webbot bot="Include" U-Include="../../../../_include/noscript.htm" TAG="BODY" startspan -->

<div class="NoScript" id="Banner">
  <div id="Links">
    <ul class="LinkList">
      <li class="LinkListItem"><a href="../../../../../../../index.htm"><span>Home</span></a> </li>
      <li class="LinkListItem"><a target="_self" href="../../../../toc.htm"><span>Table of Contents</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../../about/index.htm"><span>About This Site</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../../new/index.htm"><span>What’s New?</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../../feedback/index.htm"><span>Feedback</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../../consult/index.htm"><span>Consult</span></a> </li>
    </ul>
  </div>
  <div id="Logo">
    <p>Geoff Chappell, Software Analyst </p>
  </div>
</div>

<!--webbot bot="Include" endspan i-checksum="29544" -->
<h1>KSE_HOOK_COLLECTION </h1>
<p>An array of <span class="struct">KSE_HOOK_COLLECTION</span> structures provides 
the second level in the description of a driver shim. The top level of the description 
is a <span class="struct"><a href="shim.htm">KSE_SHIM</a></span> structure. </p>
<p>Microsoft’s name for this structure is known from symbol files for a driver (NDIS.SYS) 
that registers a shim and uses C++ for instantiating its <span class="struct">KSE_HOOK_COLLECTION</span> 
array as statically allocated data: the C++ decoration names the type. Microsoft’s 
names and types are not known for members, there being no type information in the 
symbol file. </p>
<p>The <span class="struct">KSE_HOOK_COLLECTION</span> is 0x0C and 0x18 bytes in 
32-bit and 64-bit Windows 10, respectively. </p>
<table class="Struct">
  <colgroup>
    <col class="Offset" span="2"><col class="Size"><col class="Remarks">
  </colgroup>
  <tr>
    <th>Offset (x86) </th>
    <th>Offset (x64) </th>
    <th>Size </th>
    <th>Description </th>
  </tr>
  <tr>
    <td>0x00 </td>
    <td>0x00 </td>
    <td>dword </td>
    <td>type of collection: <br>
    0 to hook imports from kernel; <br>
    1 to hook imports from HAL; <br>
    2 to hook imports from named module; <br>
    3 to hook I/O requests and other driver functions; <br>
    4 for last collection in array </td>
  </tr>
  <tr>
    <td>0x04 </td>
    <td>0x08 </td>
    <td>pointer </td>
    <td>for type 2 only: address of name of importing module, as null-terminated 
    Unicode string </td>
  </tr>
  <tr>
    <td>0x08 </td>
    <td>0x10 </td>
    <td>pointer </td>
    <td>address of <span class="struct"><a href="hook.htm">KSE_HOOK</a></span> array
    </td>
  </tr>
</table>
<p>For the last collection in the array, i.e., for type 4, all other members are 
ignored. </p>
<p>Each collection that has any other valid type must have a
<span class="struct">KSE_HOOK</span> array. If instead the pointer is
<span class="constant">NULL</span>, the shim that contains this collection cannot 
be registered. </p>
<h2>An Aside on Corrections </h2>
<p>Who’s to know how, but for the first two years of this page’s life, I had the 
name <span class="struct">KSE_HOOK_COLLECTION</span> transcribed incorrectly as 
KSE_COLLECTION. That I looked again is only because Alex Ionescu’s
<a href="http://www.alex-ionescu.com/publications/Recon/recon2016.pdf">Abusing the 
Kernel Shim Engine</a>, apparently from a conference in June 2016 but available 
in this easily readable form only since March 2017, gave a different name but no 
indication of where he got it from. He had the correct name. My notes did too, but 
my brain abbreviated while writing these pages. Now, in May 2020, Alex’s page is 
gone from Alex’s site. </p>
<div class="Footer">
  <p class="Dates">This page was created on 9th
  <a href="../../../../../../../new/16/08.htm">August 2016</a> and was last modified 
  on 27th May 2020. </p>
  <!--webbot bot="Include" U-Include="../../../../_include/c1620.htm" TAG="BODY" startspan -->

<p class="Copyright">Copyright © 2016-2020. Geoff Chappell. All rights reserved. 
<a href="../../../../../../../about/terms.htm">Conditions apply</a>. </p>

<!--webbot bot="Include" endspan i-checksum="4893" -->
</div>

</body>

</html>
