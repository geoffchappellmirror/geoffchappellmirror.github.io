<!doctype html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>New in December 2016</title>
<link rel="stylesheet" type="text/css" href="../../_styles/master.css">
<link rel="stylesheet" type="text/css" href="../../_styles/document.css">
<link rel="stylesheet" type="text/css" href="../../_styles/tree.css">
<script type="text/javascript" src="../../_scripts/master.js"></script>
<script type="text/javascript" src="../../_scripts/document.js"></script>
<script type="text/javascript" src="../../_scripts/tree.js" defer></script>
</head>

<body>

<!--webbot bot="Include" U-Include="../../_include/noscript.htm" TAG="BODY" startspan -->

<div class="NoScript Header" id="Banner">
  <div id="Links">
    <ul class="LinkList">
      <li> 
      <ul class="PreferNoWrap">
        <li class="LinkListItem"><a href="../../index.htm">Home</a> </li><!--
     --><li class="LinkListItem"><a target="_self" href="../../toc.htm">Table of Contents</a> </li><!--
     --><li class="LinkListItem"><a href="../../about/index.htm">About This Site</a> </li>
      </ul>
      <ul class="PreferNoWrap">
        <li class="LinkListItem"><a href="../index.htm">What’s New?</a> </li><!--
     --><li class="LinkListItem"><a href="../../feedback/index.htm">Feedback</a> </li><!--
     --><li class="LinkListItem"><a href="../../consult/index.htm">Consult</a> </li>
      </ul>
      </li>
    </ul>
  </div>
  <div id="Logo">
    <p><span class="PreferNoWrap">Geoff Chappell -</span> <span class="PreferNoWrap">Software Analyst</span> </p>
  </div>
</div>

<!--webbot bot="Include" endspan i-checksum="14880" -->
<div class="Main">
  <h1>New in December 2016 </h1>
  <p>Research and writing continues, though it might better not! </p>
  <h2>Kernel-Mode Windows </h2>
  <p>The attempt over the last few months to document the
  <a href="../../studies/windows/km/ntoskrnl/api/ex/sysinfo/query.htm">ZwQuerySystemInformation</a> 
  function and its companions and all their numerous cases and related structures 
  will keep me tidying up for a long while yet. That was partly the point to starting 
  it: once the overall organisation of the documentation is settled, the many cases 
  might each be picked off in otherwise idle time between items of paid work.
  </p>
  <p>One of the more complex cases of this system information pertains to Event 
  Tracing for Windows (ETW). Regular readers will know that I have long been interested 
  in ETW and was among the first critical examiners of its significantly expanded 
  use for Windows Vista. See, for instance,
  <a href="../../notes/windows/etw/security.htm">Event Trace Security</a> or
  <a href="../../studies/windows/win32/services/scm/events/eventlog.htm">The Service 
  Control Manager Eventlog Provider</a>. Now I find myself fascinated not just by 
  the diagnostic information that’s exposed through the NT Kernel Logger but also 
  by the mechanism. </p>
  <p>So much about ETW and especially about the NT Kernel Logger is undocumented, 
  not just the implementation details but even the means of using it through interfaces 
  independently of the tools that Microsoft provides in, for instance, the Windows 
  Driver Kit and the Windows Performance Toolkit. That this is very deliberate by 
  Microsoft is less troubling to me than is the programming community’s evident 
  interest in the feature but apparent lack of interest in getting the feature understood 
  in any systematic way—not even for what I’d have thought is the very practical 
  matter of developing alternatives to Microsoft’s tools. </p>
  <p>I do sympathise, sort of. More than almost anyone else, I
  <span class="emphasis">know</span> that studying a large, complex operating system 
  like Windows to a useful depth and scale would be hard work even with source code 
  to follow. But while the world does so little high-quality research into Windows, 
  what opportunities for programming Windows don’t so much go begging as get left 
  undreamt? It’s so much easier to grumble that Windows doesn’t come with source 
  code or that Microsoft is stingy with the documentation. Do something about it!
  </p>
  <div class="Tree">
    <ul>
      <li class="Expanded Branch">Kernel
      <ul>
        <li class="Expanded Branch">API
        <ul>
          <li class="Expanded Branch">Event Tracing for Windows
          <ul>
            <li class="Expanded Branch">Callouts
            <ul>
              <li><a href="../../studies/windows/km/ntoskrnl/api/etw/callouts/hookid.htm">Hook IDs</a> </li>
              <li class="Expanded Branch">Structures
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/callouts/wmi_contextswap.htm">WMI_CONTEXTSWAP</a> </li>
              </ul>
              </li>
            </ul>
            </li>
            <li class="Expanded Branch">Compressed Context Swap
            <ul>
              <li class="Expanded Branch">Structures
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/ccswap/perfinfo_ccswap_buffer.htm">PERFINFO_CCSWAP_BUFFER</a> </li>
              </ul>
              </li>
            </ul>
            </li>
            <li class="Expanded Branch">Trace Logging
            <ul>
              <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/traceheaders.htm">Trace Headers</a> </li>
              <li class="Expanded Branch">Structures
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/etw_kernel_header_extension.htm">ETW_KERNEL_HEADER_EXTENSION</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/event_header.htm">EVENT_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/event_instance_guid_header.htm">EVENT_INSTANCE_GUID_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/event_trace_header.htm">EVENT_TRACE_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/message_trace_header.htm">MESSAGE_TRACE_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/perfinfo_trace_header.htm">PERFINFO_TRACE_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/system_trace_header.htm">SYSTEM_TRACE_HEADER</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracelog/trace_logfile_header.htm">TRACE_LOGFILE_HEADER</a> </li>
              </ul>
              </li>
            </ul>
            </li>
            <li class="Expanded Branch">Trace Support
            <ul>
              <li class="Expanded Branch">Structures
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracesup/performance.htm">EVENT_TRACE_PERFORMANCE_INFORMATION</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracesup/system_event.htm">EVENT_TRACE_SYSTEM_EVENT_INFORMATION</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/etw/tracesup/time_profile.htm">EVENT_TRACE_TIME_PROFILE_INFORMATION</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/inc/api/ntwmi/perfinfo_groupmask.htm">PERFINFO_GROUPMASK</a> </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li class="Expanded Branch">Executive
          <ul>
            <li class="Expanded Branch">Profiling
            <ul>
              <li class="Expanded Branch">Functions
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/ex/profile/create.htm">NtCreateProfile</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/ex/profile/createex.htm">NtCreateProfileEx</a> </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/ex/profile/start.htm">NtStartProfile</a> (in preparation) </li>
                <li><a href="../../studies/windows/km/ntoskrnl/api/ex/profile/stop.htm">NtStopProfile</a> (in preparation) </li>
              </ul>
              </li>
            </ul>
            </li>
            <li><a href="../../studies/windows/km/ntoskrnl/api/ex/restricted_callers.htm">Restricted Callers</a> </li>
          </ul>
          </li>
          <li class="Expanded Branch">Kernel Core
          <ul>
            <li class="Expanded Branch">Profile Objects
            <ul>
              <li class="Expanded Branch">Functions
              <ul>
                <li><a href="../../studies/windows/km/ntoskrnl/api/ke/profobj/profileinterruptwithsource.htm">KeProfileInterruptWithSource</a> (in preparation) </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
    </ul>
  </div>
  <p>See that I’ve tacked on, albeit as drafts, attempts at documenting some of 
  the native API functions that support profiling. These don’t send events to loggers 
  but instead produce counters of how often a profile interrupt detects execution 
  at particular addresses. That can be invaluable diagnostic detail, whether the 
  purpose is constructive or mischievous. It really hasn’t been remarked on nearly 
  enough that for much of the history of Windows these undocumented interfaces didn’t 
  require any privilege at all even to profile kernel-mode execution from user mode, 
  and still don’t require much. Even now, these functions give an unprivileged user-mode 
  caller the means to get large amounts of data mapped into kernel-mode address 
  space and to keep changing the content and to control how long it stays there—which 
  may not be an exploitable vulnerability but is at least incautious. </p>
  <p>But that’s a side-track. I add the profiling functions not for any amount of 
  noteworthiness (though I do believe they warrant more than a little), nor even 
  because they and ETW are both for diagnostics, but because they and ETW are closely 
  related in the implementation. That’s the nature of studying a complex system: 
  one thing leads to another, which leads to another, and before you know it you 
  have a year of research laid out. How is this not someone’s paid work? </p>
  <p>On that last point, please indulge me. Google, both as a search engine reporting 
  on the world at large and as a company with its own software development, shows 
  no shortage of interest in profiling. The feature is certainly not obscure or 
  neglected, but the mechanism plainly is. If I ask Google specifically for pages 
  that mention NtCreateProfile I see nothing that’s even near to being as detailed 
  as my drafts. Yet these functions are now 20 years old. How is this left to happen?
  </p>
  <h2>User-Mode Windows </h2>
  <p>Of course, it’s not enough to start piecing together a kernel-mode knowledge 
  of ETW. Anyone who wants to put it into practice will want its user-mode interfaces. 
  It just doesn’t stop! I can’t commit to much more as free work, especially because 
  I know that highly regarded people on good salaries don’t just fumble around with 
  this feature in the hope of finding the magic incantations but actually claim 
  to make progress. If nothing else, that’s a tidy reminder of how absurd it is 
  that I do the research and writing for free. Still, let’s start with two relatively 
  new functions that are vital for getting advanced use from ETW but for which Microsoft’s 
  documentation is remarkably poor. </p>
  <div class="Tree">
    <ul>
      <li class="Expanded Branch">ADVAPI32
      <ul>
        <li class="Expanded Branch">Functions
        <ul>
          <li class="Expanded Branch">Event Tracing
          <ul>
            <li class="Expanded Branch">Logging API
            <ul>
              <li><a href="../../studies/windows/win32/advapi32/api/etw/logapi/query.htm">TraceQueryInformation</a> (in preparation) </li>
              <li><a href="../../studies/windows/win32/advapi32/api/etw/logapi/set.htm">TraceSetInformation</a> (in preparation) </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
    </ul>
  </div>
  <div class="Footer">
    <!--webbot bot="Include" U-Include="../../_include/c16.htm" TAG="BODY" startspan -->

<p class="Copyright">Copyright © 2016. Geoff Chappell. All rights reserved.  
<a href="../../about/terms.htm">Conditions apply</a>. </p>

<!--webbot bot="Include" endspan i-checksum="40420" -->
  </div>
</div>

</body>

</html>
