<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>CSR_THREAD</title>
<link rel="stylesheet" type="text/css" href="../../../../../../_styles/master.css">
<link rel="stylesheet" type="text/css" href="../../../../../../_styles/document.css">
<link rel="stylesheet" type="text/css" href="../../../_styles/win32.css">
<script type="text/javascript" src="../../../../../../_scripts/master.js"></script>
<script type="text/javascript" src="../../../../../../_scripts/document.js"></script>
<script type="text/javascript" src="../../../_scripts/win32.js"></script>
</head>

<body>

<!--webbot bot="Include" U-Include="../../../_include/noscript.htm" TAG="BODY" startspan -->

<div class="NoScript" id="Banner">
  <div id="Links">
    <ul class="LinkList">
      <li class="LinkListItem"><a href="../../../../../../index.htm"><span>Home</span></a> </li>
      <li class="LinkListItem"><a target="_self" href="../../../toc.htm"><span>Table of Contents</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../about/index.htm"><span>About This Site</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../new/index.htm"><span>What’s New?</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../feedback/index.htm"><span>Feedback</span></a> </li>
      <li class="LinkListItem"><a href="../../../../../../consult/index.htm"><span>Consult</span></a> </li>
    </ul>
  </div>
  <div id="Logo">
    <p>Geoff Chappell, Software Analyst </p>
  </div>
</div>

<!--webbot bot="Include" endspan i-checksum="54033" -->
<h1>CSR_THREAD </h1>
<p>The <span class="struct">CSR_THREAD</span> structure is what CSRSRV.DLL and the 
various server DLLs in the CSRSS.EXE server process use for representing a client 
thread. </p>
<h2>Documentation Status </h2>
<p>The <span class="struct">CSR_THREAD</span> structure is not documented. Neither 
is Microsoft known to have disclosed a C-language definition in any header from 
any publicly available kit for any sort of software development. </p>
<p>Type information for the <span class="struct">CSR_THREAD</span> is in public 
symbol files for CSRSS.EXE starting with Windows Vista. Earlier type information 
is known in a statically linked library, named GDISRVL.LIB, which Microsoft published 
with the Device Driver Kit (DDK) for Windows NT 3.51. </p>
<p>Members, but not types, are also listed by the <span class="command">!dso</span> 
command as implemented in the USEREXTS and USERKDX debugger extensions from the 
DDK for Windows 2000. </p>
<h2>Variability </h2>
<p>Considering how little of anything to do with CSRSS is documented, the
<span class="struct">CSR_THREAD</span> is surprisingly stable. Members are rearranged 
in the early versions and then a substantial withdrawal of thread-level functionality 
from CSRSS in and after version 4.0 saw the <span class="struct">CSR_THREAD</span> 
shrink, but the only change since has been one member’s removal. The following changes 
of size are known: </p>
<table class="Sizes">
  <colgroup>
    <col class="Version"><col class="Size" span="2">
  </colgroup>
  <tr>
    <th>Version </th>
    <th>Size (x86) </th>
    <th>Size (x64) </th>
  </tr>
  <tr>
    <td>3.10 </td>
    <td>0xA0 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>3.51 </td>
    <td>0x70 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>4.0 </td>
    <td>0x48 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>5.0 to 6.0 </td>
    <td>0x38 </td>
    <td>0x60 </td>
  </tr>
  <tr>
    <td>6.1 to 10.0 </td>
    <td>0x38 </td>
    <td>0x58 </td>
  </tr>
</table>
<h2>Layout </h2>
<p>These sizes and the names and types in the table that follows are from type information 
in public symbol files (or such as would ordinarily be in public symbol files) for 
version 3.51 as an isolated case and for version 6.0 and higher. What’s known of 
Microsoft’s names and types for other versions is something of a guess, being inferred 
from what use CSRSRV is seen to make of the structure. Where use of a member corresponds 
closely with that of a version for which Microsoft’s symbols are available, it seems 
reasonable to suppose continuity. Some use, however, has no correspondence, the 
code having changed too much. Even where the use hasn’t changed, tracking it down 
exhaustively would be difficult, if not impossible, even with source code. </p>
<table class="Struct">
  <colgroup>
    <col class="Offset" span="2"><col class="Definition">
  </colgroup>
  <tr>
    <th>Offset (x86) </th>
    <th>Offset (x64) </th>
    <th>Definition </th>
    <th>Versions </th>
    <th>Remarks </th>
  </tr>
  <tr>
    <td>0x00 (3.10) </td>
    <td>&nbsp;</td>
    <td>unaccounted four bytes </td>
    <td>3.10 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x00 </td>
    <td>0x00 </td>
    <td>
    <pre class="source">LARGE_INTEGER CreateTime;</pre>
    </td>
    <td>3.51 and higher </td>
    <td>previously at 0x30 </td>
  </tr>
  <tr>
    <td>0x04 (3.10); <br>
    0x08 </td>
    <td>0x08 </td>
    <td>
    <pre class="source">LIST_ENTRY Link;</pre>
    </td>
    <td>all </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x10 </td>
    <td>0x18 </td>
    <td>
    <pre class="source">LIST_ENTRY HashLinks;</pre>
    </td>
    <td>3.51 and higher </td>
    <td>previously at 0x28 </td>
  </tr>
  <tr>
    <td>0x18 </td>
    <td>0x28 </td>
    <td>
    <pre class="source">CLIENT_ID ClientId;</pre>
    </td>
    <td>3.51 and higher </td>
    <td>previously at 0x14 </td>
  </tr>
  <tr>
    <td>0x0C (3.10); <br>
    0x20 </td>
    <td>0x38 </td>
    <td>
    <pre class="source"><a href="process.htm">CSR_PROCESS</a> *Process;</pre>
    </td>
    <td>3.10 and higher </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x10 (3.10); <br>
    0x24 (3.51 to 6.0) </td>
    <td>0x40 (before 6.1) </td>
    <td>
    <pre class="source">CSR_WAIT_BLOCK *WaitBlock;</pre>
    </td>
    <td>3.10 to 6.0 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x14 (3.10) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">CLIENT_ID ClientId;</pre>
    </td>
    <td>3.10 only </td>
    <td>next at 0x18 </td>
  </tr>
  <tr>
    <td>0x1C (3.10); <br>
    0x28 (3.51 to 6.0); <br>
    0x24 </td>
    <td>0x48 (before 6.1); <br>
    0x40 </td>
    <td>
    <pre class="source">HANDLE ThreadHandle;</pre>
    </td>
    <td>3.10 to 6.1 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x20 (3.10); <br>
    0x2C (3.51 to 6.0); <br>
    0x28 </td>
    <td>0x50 (before 6.1); <br>
    0x48 </td>
    <td>
    <pre class="source">ULONG Flags;</pre>
    </td>
    <td>all </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x24 (3.10); <br>
    0x30 (3.51 to 6.0); <br>
    0x2C </td>
    <td>0x54 (before 6.1); <br>
    0x4C </td>
    <td>
    <pre class="source">ULONG ReferenceCount;</pre>
    </td>
    <td>all </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x28 (3.10) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">LIST_ENTRY HashLinks;</pre>
    </td>
    <td>3.10 only </td>
    <td>next at 0x10 </td>
  </tr>
  <tr>
    <td>0x30 (3.10) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">LARGE_INTEGER CreateTime;</pre>
    </td>
    <td>3.10 only </td>
    <td>next at 0x00 </td>
  </tr>
  <tr>
    <td>0x38 (3.10); <br>
    0x34 </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">NTSTATUS ShutDownStatus;</pre>
    </td>
    <td>3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x3C (3.10) </td>
    <td>&nbsp;</td>
    <td>unaccounted four bytes </td>
    <td>3.10 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x40 (3.10); <br>
    0x38 </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">PVOID ServerId;</pre>
    </td>
    <td>3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x3C </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">PVOID ServerThread;</pre>
    </td>
    <td>3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x44 (3.10) </td>
    <td>&nbsp;</td>
    <td>unaccounted eight bytes </td>
    <td>3.10 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x4C (3.10) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">ULONG ImpersonateCount;</pre>
    </td>
    <td>3.10 only </td>
    <td>next at 0x60 </td>
  </tr>
  <tr>
    <td>0x50 (3.10) </td>
    <td>&nbsp;</td>
    <td>unaccounted 0x24 bytes </td>
    <td>3.10 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x74 (3.10) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">BOOLEAN ThreadConnected;</pre>
    </td>
    <td>3.10 only </td>
    <td>next at 0x64 </td>
  </tr>
  <tr>
    <td>0x78 (3.10); <br>
    0x40 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">HANDLE ClientEventPairHandle;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x7C (3.10); <br>
    0x44 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">HANDLE ClientSectionHandle;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x80 (3.10); <br>
    0x48 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">CHAR *ClientSharedMemoryBase;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x84 (3.10); <br>
    0x4C (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">HANDLE ServerEventPairHandle;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x88 (3.10); <br>
    0x50 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">HANDLE ServerSectionHandle;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x8C (3.10); <br>
    0x54 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">HANDLE ServerThreadHandle;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x90 (3.10); <br>
    0x58 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">CHAR *ServerSharedMemoryBase;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x94 (3.10); <br>
    0x5C (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">ULONG SharedMemorySize;</pre>
    </td>
    <td>3.10 to 3.51 </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x60 (3.51); <br>
    0x34 (4.0 to 6.0); <br>
    0x30 </td>
    <td>0x58 (before 6.1); <br>
    0x50 </td>
    <td>
    <pre class="source">ULONG ImpersonateCount;</pre>
    </td>
    <td>3.51 to 6.1 </td>
    <td>previously at 0x4C </td>
  </tr>
  <tr>
    <td>0x64 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">BOOLEAN ThreadConnected;</pre>
    </td>
    <td>3.51 only </td>
    <td>previously at 0x74 </td>
  </tr>
  <tr>
    <td>0x65 (3.51) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">BOOLEAN Dying;</pre>
    </td>
    <td>3.51 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x38 (4.0) </td>
    <td>&nbsp;</td>
    <td>unaccounted eight bytes </td>
    <td>4.0 only </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>0x9C (3.10); <br>
    0x68 (3.51); <br>
    0x40 (4.0) </td>
    <td>&nbsp;</td>
    <td>
    <pre class="source">PVOID ServerDllPerThreadData [1];</pre>
    </td>
    <td>3.10 to 4.0 </td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>No use is known of the <span class="member">Dying</span> member even in the version 
for which type information shows it as defined. </p>
<p>Up to and including version 4.0, the <span class="struct">CSR_THREAD</span> is 
built in a memory block that continues with: </p>
<ul>
  <li>as many <span class="member">ServerDllPerThreadData</span> elements as there 
  can be server DLLs; </li>
  <li>as much additional per-thread space as the server DLLs have collectively requested.
  </li>
</ul>
<p>A server DLL requests per-thread space for all future processes by setting the 
wanted amount into the <span class="member">PerThreadDataLength</span> member of 
the <span class="struct">CSR_SERVER_DLL</span> during initialisation. Each server 
DLL’s allowance is aligned up to 4 bytes in version 3.10 but 8 bytes in later versions. 
Each <span class="member">ServerDllPerThreadData</span> element points to the allowance 
for the corresponding server DLL (or is <span class="constant">NULL</span> if the 
server DLL has no per-thread space). </p>
<div class="Footer">
  <p class="Dates">This page was created on 21st
  <a href="../../../../../../new/19/06.htm">June 2019</a> and was last modified 
  on 23rd June 2019. </p>
  <!--webbot bot="Include" U-Include="../../../_include/c19.htm" TAG="BODY" startspan -->

<p class="Copyright">Copyright © 2019. Geoff Chappell. All rights reserved. 
<a href="../../../../../../about/terms.htm">Conditions apply</a>. </p>

<!--webbot bot="Include" endspan i-checksum="62933" -->
</div>

</body>

</html>
