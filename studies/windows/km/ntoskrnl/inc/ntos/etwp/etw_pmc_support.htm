<!doctype html>
<html lang="en">

<head>
<title>ETW_PMC_SUPPORT</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../_styles/master.css">
<link rel="stylesheet" type="text/css" href="../../../../../../../_styles/document.css">
<link rel="stylesheet" type="text/css" href="../../../../_styles/km.css">
<script type="text/javascript" src="../../../../../../../_scripts/master.js"></script>
<script type="text/javascript" src="../../../../../../../_scripts/document.js"></script>
<script type="text/javascript" src="../../../../_scripts/km.js" defer></script>
</head>

<body>

<!--webbot bot="Include" U-Include="../../../../_include/noscript.htm" TAG="BODY" startspan -->

<div class="NoScript" id="Banner">
  <div id="Links">
    <ul class="LinkList">
      <li> 
      <ul class="PreferNoWrap">
        <li class="LinkListItem"><a href="../../../../../../../index.htm">Home</a> </li><!--
     --><li class="LinkListItem"><a target="_self" href="../../../../toc.htm">Table of Contents</a> </li><!--
     --><li class="LinkListItem"><a href="../../../../../../../about/index.htm">About This Site</a> </li>
      </ul>
      <ul class="PreferNoWrap">
        <li class="LinkListItem"><a href="../../../../../../../new/index.htm">What’s New?</a> </li><!--
     --><li class="LinkListItem"><a href="../../../../../../../feedback/index.htm">Feedback</a> </li><!--
     --><li class="LinkListItem"><a href="../../../../../../../consult/index.htm">Consult</a> </li>
      </ul>
      </li>
    </ul>
  </div>
  <div id="Logo">
    <p><span class="PreferNoWrap">Geoff Chappell -</span> <span class="PreferNoWrap">Software Analyst</span> </p>
  </div>
</div>

<!--webbot bot="Include" endspan i-checksum="48540" -->
<div class="Main">
  <h1>ETW_PMC_SUPPORT </h1>
  <p>The <span class="struct">ETW_PMC_SUPPORT</span> structure is created for an 
  event logger when processor performance monitoring is enabled for it. Such requests 
  reach the kernel only through <span class="function">
  <a href="../../../api/ex/sysinfo/set.htm">ZwSetSystemInformation</a></span> or
  <span class="function">NtSetSystemInformation</span> when given the information 
  class <span class="constant">SystemPerformanceTraceInformation</span> (0x1F) with 
  an information buffer whose first dword is <span class="constant">EventTraceProfileEventListInformation</span> 
  (0x0E) or <span class="constant">EventTraceProfileCounterListInformation</span> 
  (0x0F). </p>
  <h2>Documentation Status </h2>
  <p>The <span class="struct">ETW_PMC_SUPPORT</span> structure is not documented.
  </p>
  <h2>Variability </h2>
  <p>The <span class="struct">ETW_PMC_SUPPORT</span> looked stable for several versions, 
  but variability has since set in. The following changes of size are known: </p>
  <table class="Sizes">
    <colgroup>
      <col class="Version"><col class="Size" span="2">
    </colgroup>
    <thead>
      <tr>
        <th>Version </th>
        <th>Size (x86) </th>
        <th>Size (x64) </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>6.2 to 1607 </td>
        <td>0x24 </td>
        <td>0x28 </td>
      </tr>
      <tr>
        <td>1703 to 1809 </td>
        <td>0x34 </td>
        <td>0x38 </td>
      </tr>
      <tr>
        <td>1903 to 2004 </td>
        <td>0x18 </td>
        <td>0x20 </td>
      </tr>
    </tbody>
  </table>
  <h2>Layout </h2>
  <p>Offsets, types and names in the table below are from symbol files for the kernel 
  in Windows 8 and higher. </p>
  <table class="Struct">
    <colgroup>
      <col class="Offset" span="2"><col class="Definition">
      <col class="Versions">
    </colgroup>
    <thead>
      <tr>
        <th>Offset (x86) </th>
        <th>Offset (x64) </th>
        <th>Definition </th>
        <th>Versions </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="3">0x00 </td>
        <td rowspan="3">0x00 </td>
        <td>
        <pre class="source"><a href="../../../api/ke/profobj/kprofile_source.htm">KPROFILE_SOURCE</a> Source [4];</pre>
        </td>
        <td>6.2 to 1607 </td>
      </tr>
      <tr>
        <td>
        <pre class="source">KPROFILE_SOURCE Source [8];</pre>
        </td>
        <td>1703 to 1809 </td>
      </tr>
      <tr>
        <td>
        <pre class="source">KPROFILE_SOURCE *Source;</pre>
        </td>
        <td>1903 and higher </td>
      </tr>
      <tr>
        <td>0x10 (6.2 to 1607); <br>
        0x20 (1703 to 1809); <br>
        0x04 </td>
        <td>0x10 (6.2 to 1607); <br>
        0x20 (1703 to 1809); <br>
        0x08 </td>
        <td>
        <pre class="source">ULONG volatile HookIdCount;</pre>
        </td>
        <td>6.2 and higher </td>
      </tr>
      <tr>
        <td>0x14 (6.2 to 1607); <br>
        0x24 (1703 to 1809); <br>
        0x08 </td>
        <td>0x14 (6.2 to 1607); <br>
        0x24 (1703 to 1809); <br>
        0x0C </td>
        <td>
        <pre class="source">USHORT HookId [4];</pre>
        </td>
        <td>6.2 and higher </td>
      </tr>
      <tr>
        <td>0x1C (6.2 to 1607); <br>
        0x2C (1703 to 1809); <br>
        0x10 </td>
        <td>0x1C (6.2 to 1607); <br>
        0x2C (1703 to 1809); <br>
        0x14 </td>
        <td>
        <pre class="source">ULONG volatile CountersCount;</pre>
        </td>
        <td>6.2 and higher </td>
      </tr>
      <tr>
        <td>0x20 (6.2 to 1607); <br>
        0x30 (1703 to 1809); <br>
        0x14 </td>
        <td>0x20 (6.2 to 1607); <br>
        0x30 (1703 to 1809); <br>
        0x18 </td>
        <td>
        <pre class="source">HAL_PMC_COUNTERS *ProcessorCtrs [ANYSIZE_ARRAY];</pre>
        </td>
        <td>6.2 and higher </td>
      </tr>
    </tbody>
  </table>
  <p>The structure is always allocated from non-paged no-execute pool. Its address 
  is kept as the <span class="member">PmcData</span> member of the
  <span class="struct">
  <a href="wmi_logger_context/index.htm">WMI_LOGGER_CONTEXT</a></span> 
  that represents the event logger. </p>
  <p>Each logger can nominate up to four counters (but more in later versions). 
  These are selected from the <span class="enum">KPROFILE_SOURCE</span> enumeration 
  that is defined in WDM.H and lists the types of information that the HAL may keep 
  about processor performance. The profile sources are provided as the
  <span class="member">ProfileSources</span> member of the <span class="struct">
  <a href="../../api/ntetw/event_trace_profile_counter_information.htm">EVENT_TRACE_PROFILE_COUNTER_INFORMATION</a></span> 
  that is the required input for the relevant case of <span class="function">ZwSetSystemInformation</span>.
  </p>
  <p>The <span class="member">ProcessorCtrs</span> array has as many elements as 
  there can ever be processors. Each is a pointer to a <span class="struct">HAL_PMC_COUNTERS</span> 
  structure for which Microsoft’s symbol files do not provide type information. 
  From the NTOSP.H header in the original and Version 1511 editions of the Windows 
  Driver Kit (WDK) for Windows 10, it is known that Microsoft defines the type
  <span class="type">PMC_HANDLE</span> for this pointer. </p>
  <div class="Footer">
    <p class="Dates">This page was created on 30th
    <a href="../../../../../../../new/16/11.htm">November 2016</a> and was last 
    modified on 17th October 2022. </p>
    <!--webbot bot="Include" U-Include="../../../../_include/c1622.htm" TAG="BODY" startspan -->

<p class="Copyright">Copyright © 2016-2022. Geoff Chappell. All rights reserved. 
<a href="../../../../../../../about/terms.htm">Conditions apply</a>. </p>

<!--webbot bot="Include" endspan i-checksum="4925" -->
  </div>
</div>

</body>

</html>
